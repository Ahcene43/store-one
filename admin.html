<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المتجر</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- إضافة ملف الإعدادات -->
    <script src="config.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Cairo", sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            direction: rtl;
        }
        
        .admin-container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #FF6B8B, #E05575);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 139, 0.3);
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section h3 {
            color: #FF6B8B;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #FF6B8B;
            outline: none;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF6B8B, #E05575);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #06D6A0, #05b88c);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4ECDC4, #3BB4AC);
            color: white;
        }
        
        .product-item {
            border: 2px dashed #FF6B8B;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: #f8fafc;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .tab.active {
            background: #FF6B8B;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .login-screen {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 50px;
        }
        
        .login-screen h2 {
            color: #FF6B8B;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .small-btn {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            margin: 2px;
        }
        
        .image-upload-container {
            position: relative;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 10px;
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #4ECDC4, #3BB4AC);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .upload-btn i {
            margin-left: 5px;
        }
        
        .upload-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .upload-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .github-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px dashed #ddd;
        }
        
        .size-color-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .size-color-item {
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .size-color-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 5px;
            background: white;
        }
        
        .size-color-list div {
            padding: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .size-color-list div:last-child {
            border-bottom: none;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .password-strength {
            margin-top: 5px;
            font-size: 12px;
        }
        
        .strength-weak { color: #e74c3c; }
        .strength-medium { color: #f39c12; }
        .strength-strong { color: #27ae60; }
    </style>
</head>
<body>
    <!-- شاشة الدخول -->
    <div id="loginScreen" class="login-screen">
        <h2>🔒 دخول المدير</h2>
        <div class="form-group">
            <input type="password" id="adminPassword" placeholder="أدخل كلمة المرور" style="text-align: center;">
        </div>
        <button class="btn btn-primary" onclick="login()">دخول</button>
        <div id="loginError" style="color: #e74c3c; margin-top: 10px; display: none;">
            كلمة المرور غير صحيحة!
        </div>
        <p style="margin-top: 15px; color: #666; font-size: 14px;">
            كلمة المرور الافتراضية: admin123
        </p>
    </div>

    <!-- لوحة التحكم الرئيسية -->
    <div id="adminPanel" class="admin-container hidden">
        <div class="header">
            <h1>🛠️ لوحة تحكم المتجر</h1>
            <p>إدارة جميع إعدادات المتجر من هنا</p>
        </div>

        <!-- ألسنة التبويب -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">🛍️ المنتجات</button>
            <button class="tab" onclick="switchTab('delivery')">🚚 التوصيل</button>
            <button class="tab" onclick="switchTab('settings')">⚙️ الإعدادات</button>
            <button class="tab" onclick="switchTab('security')">🔐 الأمان</button>
            <button class="tab" onclick="switchTab('upload')">📤 رفع الصور</button>
        </div>

        <!-- قسم المنتجات -->
        <div id="products" class="tab-content active">
            <div class="section">
                <h3>📦 إدارة المنتجات</h3>
                <div id="productsList">
                    <!-- سيتم ملؤها بالمنتجات -->
                </div>
                <button class="btn btn-secondary" onclick="addNewProduct()">
                    ➕ إضافة منتج جديد
                </button>
            </div>
        </div>

        <!-- قسم التوصيل -->
        <div id="delivery" class="tab-content">
            <div class="section">
                <h3>🗺️ أسعار التوصيل</h3>
                <div class="form-group">
                    <label>اختر الولاية:</label>
                    <select id="wilayaSelect" onchange="loadWilayaPrice()">
                        <option value="">-- اختر الولاية --</option>
                    </select>
                </div>
                <div id="wilayaPriceForm" class="hidden">
                    <div class="form-group">
                        <label>سعر التوصيل للمنزل:</label>
                        <input type="number" id="homePrice" placeholder="السعر">
                    </div>
                    <div class="form-group">
                        <label>سعر التوصيل للمكتب:</label>
                        <input type="number" id="deskPrice" placeholder="السعر">
                    </div>
                    <button class="btn btn-primary" onclick="saveWilayaPrice()">💾 حفظ السعر</button>
                </div>
            </div>
        </div>

        <!-- قسم الإعدادات -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h3>🎯 إعدادات الخصم</h3>
                <div class="form-group">
                    <label>الحد الأدنى للكمية للخصم:</label>
                    <input type="number" id="minQuantity" min="2" value="2">
                </div>
                <div class="form-group">
                    <label>قيمة الخصم لكل قطعة (دج):</label>
                    <input type="number" id="discountValue" value="300">
                </div>
                <button class="btn btn-primary" onclick="saveDiscountSettings()">💾 حفظ الخصم</button>
            </div>

            <div class="section">
                <h3>🏪 معلومات المتجر</h3>
                <div class="form-group">
                    <label>اسم المتجر:</label>
                    <input type="text" id="storeName" placeholder="اسم المتجر">
                </div>
                <div class="form-group">
                    <label>شعار المتجر:</label>
                    <input type="text" id="storeTagline" placeholder="شعار المتجر">
                </div>
                <div class="form-group">
                    <label>أرقام الهاتف (مفصولة بفاصلة):</label>
                    <input type="text" id="storePhones" placeholder="مثال: 0671466489, 0551102155">
                </div>
                <button class="btn btn-primary" onclick="saveStoreInfo()">💾 حفظ المعلومات</button>
            </div>

            <div class="section">
                <h3>📏 القياسات المتاحة</h3>
                <div class="form-group">
                    <label>القياسات المتاحة (مفصولة بفاصلة):</label>
                    <input type="text" id="availableSizes" placeholder="S, M, L, XL, XXL">
                    <small style="color: #666;">افصل بين القياسات بفاصلة</small>
                </div>
                <button class="btn btn-primary" onclick="saveAvailableSizes()">💾 حفظ القياسات</button>
            </div>

            <div class="section">
                <h3>🎨 الألوان المتاحة</h3>
                <div class="form-group">
                    <label>الألوان المتاحة (مفصولة بفاصلة):</label>
                    <input type="text" id="availableColors" placeholder="أبيض, أسود, أحمر, أزرق">
                    <small style="color: #666;">افصل بين الألوان بفاصلة</small>
                </div>
                <button class="btn btn-primary" onclick="saveAvailableColors()">💾 حفظ الألوان</button>
            </div>

            <div class="section">
                <h3>📊 جدول الأعمار والقياسات</h3>
                <div id="ageSizesList">
                    <!-- سيتم ملؤها بجدول الأعمار والقياسات -->
                </div>
                <button class="btn btn-secondary" onclick="addNewAgeSize()">
                    ➕ إضافة عمر جديد
                </button>
            </div>
        </div>

        <!-- قسم الأمان -->
        <div id="security" class="tab-content">
            <div class="section">
                <h3>🔐 إعدادات الأمان</h3>
                <div class="form-group">
                    <label>كلمة المرور الحالية:</label>
                    <input type="password" id="currentPassword" placeholder="أدخل كلمة المرور الحالية">
                </div>
                <div class="form-group">
                    <label>كلمة المرور الجديدة:</label>
                    <input type="password" id="newPassword" placeholder="أدخل كلمة المرور الجديدة" oninput="checkPasswordStrength()">
                    <div id="passwordStrength" class="password-strength"></div>
                </div>
                <div class="form-group">
                    <label>تأكيد كلمة المرور الجديدة:</label>
                    <input type="password" id="confirmPassword" placeholder="أعد إدخال كلمة المرور الجديدة">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">💾 تغيير كلمة المرور</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>مدة انتهاء الجلسة (بالدقائق):</label>
                    <input type="number" id="sessionTimeout" min="5" max="240" value="30">
                    <small style="color: #666;">سيتم تسجيل الخروج تلقائياً بعد هذه المدة</small>
                </div>
                <button class="btn btn-secondary" onclick="saveSessionSettings()">💾 حفظ إعدادات الجلسة</button>
            </div>
        </div>

        <!-- قسم رفع الصور -->
        <div id="upload" class="tab-content">
            <div class="section">
                <h3>📤 رفع الصور إلى GitHub</h3>
                
                <div class="github-config">
                    <h4>⚙️ إعدادات GitHub</h4>
                    <div class="form-group">
                        <label>توكن GitHub الشخصي:</label>
                        <input type="password" id="githubToken" placeholder="أدخل التوكن الشخصي من GitHub">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            اذهب إلى GitHub → Settings → Developer settings → Personal access tokens
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label>اسم المستخدم على GitHub:</label>
                        <input type="text" id="githubUsername" placeholder="اسم المستخدم">
                    </div>
                    
                    <div class="form-group">
                        <label>اسم المستودع:</label>
                        <input type="text" id="githubRepo" placeholder="اسم المستودع">
                    </div>
                    
                    <div class="form-group">
                        <label>الفرع (Branch):</label>
                        <input type="text" id="githubBranch" placeholder="main" value="main">
                    </div>
                    
                    <button class="btn btn-secondary" onclick="saveGithubConfig()">💾 حفظ إعدادات GitHub</button>
                </div>
                
                <div class="form-group">
                    <label>اختر صورة للرفع:</label>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <div class="upload-btn" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i> اختر صورة
                    </div>
                </div>
                
                <div class="image-upload-container">
                    <img id="imagePreview" class="image-preview" alt="معاينة الصورة">
                    <div id="uploadStatus" class="upload-status"></div>
                </div>
                
                <div class="form-group">
                    <label>رابط الصورة بعد الرفع:</label>
                    <input type="text" id="imageUrl" readonly placeholder="سيظهر رابط الصورة هنا بعد الرفع">
                    <button class="btn btn-secondary small-btn" onclick="copyImageUrl()" style="margin-top: 10px;">
                        📋 نسخ الرابط
                    </button>
                </div>
                
                <button class="btn btn-primary" id="uploadButton" onclick="uploadImage()" disabled>
                    ⬆️ رفع الصورة إلى GitHub
                </button>
            </div>
        </div>

        <!-- أزرار التحكم -->
        <div class="section">
            <h3>🛡️ إجراءات النظام</h3>
            <button class="btn btn-success" onclick="saveAllSettings()">
                💾 حفظ جميع الإعدادات
            </button>
            <button class="btn btn-secondary" onclick="exportSettings()">
                📤 تصدير الإعدادات
            </button>
            <button class="btn btn-danger" onclick="resetSettings()">
                🔄 إعادة التعيين
            </button>
            <button class="btn btn-primary" onclick="goToStore()">
                🏪 الذهاب للمتجر
            </button>
            <button class="btn btn-danger" onclick="logout()">
                🚪 تسجيل الخروج
            </button>
        </div>

        <!-- استيراد الإعدادات -->
        <div class="section">
            <h3>📥 استيراد الإعدادات</h3>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSettings(this)">
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                📁 اختيار ملف الإعدادات
            </button>
        </div>
    </div>

    <script>
        let CONFIG = STORE_CONFIG;
        let selectedImageFile = null;
        let sessionTimer = null;

        // الدخول للنظام
        function login() {
            const password = document.getElementById('adminPassword').value;
            const savedPassword = CONFIG.ADMIN_SETTINGS.password;
            
            if (password === savedPassword) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadSettings();
                loadGithubConfig();
                
                // بدء مؤقت الجلسة
                startSessionTimer();
                
                // إخفاء رسالة الخطأ إذا كانت ظاهرة
                document.getElementById('loginError').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // بدء مؤقت الجلسة
        function startSessionTimer() {
            const timeoutMinutes = CONFIG.ADMIN_SETTINGS.sessionTimeout || 30;
            const timeoutMs = timeoutMinutes * 60 * 1000;
            
            // إلغاء المؤقت السابق إذا كان موجوداً
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            
            // بدء مؤتمر جديد
            sessionTimer = setTimeout(() => {
                alert('انتهت مدة الجلسة. يرجى تسجيل الدخول مرة أخرى.');
                logout();
            }, timeoutMs);
        }

        // إعادة تعيين المؤقت عند التفاعل مع الصفحة
        function resetSessionTimer() {
            startSessionTimer();
        }

        // إضافة مستمعي الأحداث لإعادة تعيين المؤقت
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('keypress', resetSessionTimer);
        document.addEventListener('scroll', resetSessionTimer);

        // تسجيل الخروج
        function logout() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
            
            // إلغاء مؤقت الجلسة
            if (sessionTimer) {
                clearTimeout(sessionTimer);
                sessionTimer = null;
            }
        }

        // تحميل الإعدادات
        function loadSettings() {
            CONFIG = loadConfig();
            loadProductsManagement();
            loadWilayasList();
            loadDiscountSettings();
            loadStoreInfo();
            loadAgeSizes();
            loadAvailableColors();
            loadAvailableSizes();
            loadSecuritySettings();
        }

        // تبديل الألسنة
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // إدارة الأمان
        function loadSecuritySettings() {
            document.getElementById('sessionTimeout').value = CONFIG.ADMIN_SETTINGS.sessionTimeout || 30;
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthElement = document.getElementById('passwordStrength');
            
            let strength = 0;
            let message = '';
            let className = '';
            
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;
            
            if (password.length === 0) {
                message = '';
                className = '';
            } else if (password.length < 6) {
                message = 'ضعيفة جداً';
                className = 'strength-weak';
            } else if (strength < 3) {
                message = 'ضعيفة';
                className = 'strength-weak';
            } else if (strength === 3) {
                message = 'متوسطة';
                className = 'strength-medium';
            } else {
                message = 'قوية';
                className = 'strength-strong';
            }
            
            strengthElement.textContent = message;
            strengthElement.className = 'password-strength ' + className;
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentPassword !== CONFIG.ADMIN_SETTINGS.password) {
                alert('كلمة المرور الحالية غير صحيحة');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('كلمة المرور الجديدة يجب أن تكون 6 أحرف على الأقل');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('كلمة المرور الجديدة غير متطابقة');
                return;
            }
            
            CONFIG.ADMIN_SETTINGS.password = newPassword;
            saveAllSettings();
            alert('✅ تم تغيير كلمة المرور بنجاح');
            
            // مسح الحقول
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordStrength').textContent = '';
        }

        function saveSessionSettings() {
            const timeout = parseInt(document.getElementById('sessionTimeout').value);
            if (timeout >= 5 && timeout <= 240) {
                CONFIG.ADMIN_SETTINGS.sessionTimeout = timeout;
                saveAllSettings();
                startSessionTimer(); // إعادة بدء المؤقت بالإعدادات الجديدة
                alert('✅ تم حفظ إعدادات الجلسة');
            } else {
                alert('يرجى إدخال مدة بين 5 و 240 دقيقة');
            }
        }

        // ... باقي الدوال تبقى كما هي (إدارة المنتجات، التوصيل، الخصم، إلخ)

        // الإجراءات الرئيسية
        function saveAllSettings() {
            STORE_CONFIG = CONFIG;
            saveConfig();
            alert('✅ تم حفظ جميع الإعدادات بنجاح!');
        }

        // تحميل الإعدادات عند فتح الصفحة
        window.onload = function() {
            // لا تحفظ حالة الدخول - مطلوب كلمة المرور في كل مرة
            logout(); // تأكد من ظهور شاشة الدخول
        };
    </script>
</body>
</html>
